
## 定义
```
将一个端口的请求转到另一个端口
```

## 问题
```
# 1. 前提
00. 网络机器: host-10 host-20
01. 本地机器: host-30 host-40 host-50
02. 本地机器之间可以直接相互访问
03. 网络机器之间可以直接相互访问
04. 网路机器不能直接访问本地机器
05. 本地机器 host-30   能直接访问网络机器 host-20, 但 不能直接访问网络机器 host-10
06. 本地机器 host-40 不能直接访问网络机器 host-10 host-20
07. 本地机器 host-50 不能直接访问网络机器 host-10 host-20
08. 网络机器 host-10 有一服务, 端口号是 1234
09. 网络机器 host-20 有一服务, 端口号是 1234
10. 本地机器 host-50 有一服务, 端口号是 1234

# 2. 问题
1. 本地机器 host-40 host-50 如何访问 网络机器 host-20 上的服务 --- 内网访问外网
2. 本地机器 host-30 host-40 host-50 如何访问 网络机器 host-10 上的服务 --- 访问 Google
3. 网络机器 host-10 host-20 如何访问 本地机器 host-50 上的服务 --- 外网访问内网
```

## 测试环境
```
# 1. 五台虚拟机
192.168.198.10, 模拟网络机器 host-10, 启动服务: nc -lkv 1234
192.168.198.20, 模拟网络机器 host-20, 启动服务: nc -lkv 1234
192.168.198.30, 模拟本地机器 host-30
192.168.198.40, 模拟本地机器 host-40
192.168.198.50, 模拟本地机器 host-50, 启动服务: nc -lkv 1234

# 2. 每台虚拟机上依次执行
sudo firewall-cmd --permanent --add-port=1234/tcp; # 1. 开启端口号
sudo firewall-cmd --permanent --add-port=4567/tcp; # 2. 开启端口号
sudo firewall-cmd --reload;                        # 3. 重新加载防火墙
sudo firewall-cmd --list-ports;                    # 4. 查看所有打开的端口

# 3. 允许本地端口转发 -- 需要 root 权限
在 /etc/ssh/sshd_config 内添加配置项: AllowTcpForwarding yes
重启 sshd 服务: sudo systemctl restart sshd;

# 4. 允许远程端口转发 -- 需要 root 权限
在 /etc/ssh/sshd_config 内添加配置项: GatewayPorts yes
重启 sshd 服务: sudo systemctl restart sshd;
```

## 问题一:  本地机器 host-40 host-50 如何访问 网络机器 host-20 上的服务 --- 内网访问外网
```
# 1. 方案一
1. 在 host-30 上设置允许本地端口转发
2. 在 host-30 上执行: ssh -CqTnNf -L 0.0.0.0:4567:192.168.198.20:1234 lyb@192.168.198.30
    将本机的 4567 端口号的数据, 转发到 host-20 的 1234 端口号
    此时, host-30 和 host-30:22 建立了连接
    此时, 本机的 4567 端口处于监听状态: ss -taln
3. host-40 连接 host-30 的 4567 端口号: nc 192.168.198.30 4567
    此时, host-40 和 host-30:4567 端口号建立了连接
    此时, host-30 和 host-20:1234 端口号建立了连接
    此时, host-20:1234 收到 host-30 的数据
    建立端口转发: host-30 -> host-20
    数据流: host-40 -> host-30:4567 (明文, 跨机器)
            host-30 -> host-30:22   (已使用 ssh 加密) (设置端口转发时已建立好的)
            host-30 -> host-20:1234 (已使用 ssh 加密)
    建立连接和数据流的方向是一致的
4. host-50 连接 host-30 的 4567 端口号: nc 192.168.198.30 4567
    和上面类似

# 2. 方案二
1. 在 host-30 上设置允许本地端口转发
2. 在 host-40 上执行: ssh -CqTnNf -L 0.0.0.0:4567:192.168.198.20:1234 lyb@192.168.198.30
    将本机的 4567 端口号的数据, 经由 host-30 转发到 host-20 的 1234 端口号
    此时, host-40 和 host-30:22 建立了连接
    此时, 本机的 4567 端口处于监听状态: ss -taln
3. host-40 连接 host-40 的 4567 端口号: nc 192.168.198.40 4567
    此时, host-40 和 host-40:4567 端口号建立了连接
    此时, host-30 和 host-20:1234 端口号建立了连接
    此时, host-20:1234 收到 host-30 的数据
    建立端口转发: host-40 -> host-30 -> host-20
    数据流: host-40 -> host-40:4567 (明文, 但在本机传递)
            host-40 -> host-30:22   (已使用 ssh 加密) (设置端口转发时已建立好的)
            host-30 -> host-20:1234 (已使用 ssh 加密)
    建立连接和数据流的方向是一致的
4. host-50 连接 host-40 的 4567 端口号: nc 192.168.198.30 4567
    和上面类似, 但 host-50 到 host-40:4567 的数据是跨机器的明文

# 3. 方案三
1. 在 host-30 上设置允许本地端口转发
2. 在 host-50 上执行: ssh -CqTnNf -L 0.0.0.0:4567:192.168.198.20:1234 lyb@192.168.198.30
    其他和 方案二 类似

# 4. 方案四
1. 在 host-30 上执行
1.1 查看端口转发: sudo firewall-cmd --list-forward-ports;
1.2 将本机的 4567 端口转发到 host-20 的 1234
    sudo firewall-cmd --add-forward-port=port=4567:proto=tcp:toaddr=192.168.198.20:toport=1234;
1.3 开启伪装 IP: sudo firewall-cmd --add-masquerade;
1.4 此时, 4567 并没有处于监听状态: ss -taln
2. 此时, host-30 上访问失败: nc 192.168.198.30 4567
3. 此时, host-40 上访问成功: nc 192.168.198.30 4567
    host-40 -> host-30:4567
    host-30 -> host-20:1234
4. 此时, host-50 上访问成功: nc 192.168.198.30 4567
    host-50 -> host-30:4567
    host-30 -> host-20:1234
5. 在 host-30 上移除端口转发:
    sudo firewall-cmd --remove-forward-port=port=4567:proto=tcp:toaddr=192.168.198.20:toport=1234
6. 在 host-30 上禁止IP伪装: sudo firewall-cmd --remove-masquerade
```
















# 2. 解决一 (在 host-20 上不能访问转发的端口)


# 5. 解决二 (在 host-10 上不能访问转发的端口)
1. 在 host-10 上开启端口转发
    1.1 查看端口转发: sudo firewall-cmd --list-forward-ports
    1.2 执行端口转发, 将本机的 4567 端口转发到 host-10 的 1234
        sudo firewall-cmd --add-forward-port=port=4567:proto=tcp:toaddr=192.168.198.10:toport=1234
    1.3 不需要开启伪装 IP
    1.4 此时, 4567 并没有处于监听状态: ss -taln
2. 此时, host-10 上访问失败: nc 192.168.198.10 4567
3. 此时, host-20 上访问成功: nc 192.168.198.10 4567 (实际上是与 1234 相连)
    host-20 -> host-10:1234
4. 在 host-10 上移除端口转发:
    sudo firewall-cmd --remove-forward-port=port=4567:proto=tcp:toaddr=192.168.198.10:toport=1234

# 6. 解决三 rich language -- 只允许 非本机访问 -- 使用 vps 验证
1. sudo firewall-cmd --permanent --delete-policy=portforward; # 1. 删除旧策略 (可选)
2. sudo firewall-cmd --permanent --new-policy=portforward;    # 2. 新增新策略
3. sudo firewall-cmd --permanent --add-port=1234/tcp;         # 3. 添加端口号
4. sudo firewall-cmd --permanent --add-port=4567/tcp;
5. sudo firewall-cmd --permanent --policy=portforward --add-ingress-zone=ANY;  # 4. 设置入口网络访问
6. sudo firewall-cmd --permanent --policy=portforward --add-egress-zone=ANY;   # 5. 设置出口
7. sudo firewall-cmd --permanent --policy=portforward --add-rich-rule='rule family="ipv4" forward-port port="4567" protocol="tcp" to-port="1234" to-addr="144.168.57.124"';     # 6. 设置端口转发
8. sudo firewall-cmd --reload;                            # 7. 重新加载防火墙
9. 启动服务: nc -lkv 1234
10. 此时, 4567 不处于监听状态: ss -taln
11.   本机访问: nc 144.168.57.124 4567 -- 失败
12. 非本机访问: nc 144.168.57.124 4567 -- 成功 (实际上是与 1234 相连)

# 7. 解决三 rich language -- 只允许 非本机访问 -- 使用 vps 验证
1. sudo firewall-cmd --permanent --delete-policy=portforward; # 1. 删除旧策略 (可选)
2. sudo firewall-cmd --permanent --new-policy=portforward;    # 2. 新增新策略
3. sudo firewall-cmd --permanent --add-port=1234/tcp;         # 3. 添加端口号
4. sudo firewall-cmd --permanent --add-port=4567/tcp;
5. sudo firewall-cmd --permanent --policy=portforward --add-ingress-zone=HOST; # 4. 设置入口本机访问
6. sudo firewall-cmd --permanent --policy=portforward --add-egress-zone=ANY;   # 5. 设置出口
7. sudo firewall-cmd --permanent --policy=portforward --add-rich-rule='rule family="ipv4" forward-port port="4567" protocol="tcp" to-port="1234" to-addr="144.168.57.124"';     # 6. 设置端口转发
8. sudo firewall-cmd --reload;                            # 7. 重新加载防火墙
9. 启动服务: nc -lkv 1234
10. 此时, 4567 不处于监听状态: ss -taln
11. 非本机访问: nc 144.168.57.124 4567 -- 成功 (实际上是与 1234 相连)
12.   本机访问: nc 144.168.57.124 4567 -- 失败
```




    如果只是本机访问的话, 不需要设置


# 3. 远程端口转发
# 3.1 问题
* host-10 上有一服务
* host-20 可以直接访问 host-10 上的服务
* host-30 和 host-40 无法直接访问 host-10 上的服务
* host-30 和 host-40 无法直接连接 host-20 (这一行和上面有区别)
* host-20 可以直连 host-30 和 host-40 (这一行新增)
* host-30 和 host-40 如何才能访问 host-10 上的服务

# 3.2 基础设置
1. host-10 开启防火墙端口号: sudo firewall-cmd --add-port=1234/tcp;
2. host-10 启动服务: nc -lkv 1234
4. host-30 开启防火墙端口号: sudo firewall-cmd --add-port=4567/tcp;

# 3.3 解决
1. 在 host-20 执行: ssh -CqTnNf -R 0.0.0.0:4567:192.168.198.10:1234 lyb@192.168.198.30
    将 host-30 的 4567 端口号的数据, 经由 host-20 转发到 host-10 的 1234 端口号
    此时, host-20 和 host-30:22 建立了连接
    此时, host-30 上的 4567 处于监听状态: ss -taln
2. host-40 连接 host-30 的 4567 端口号: nc 192.168.198.30 4567
    此时, host-40 和 host-30:4567 端口号建立了连接
    此时, host-20 和 host-10:1234 端口号建立了连接
    此时, host-10:1234 收到 host-20 的数据
    建立端口转发: host-20 -> host-30
    数据流: host-40 -> host-30:4567
            host-30 -> host-20:22 (设置端口转发时已建立好的)
            host-20 -> host-10:1234
    建立连接和数据流的方向是相反
    此时, host-40 到 host-30 的数据是不加密的
3. host-30 连接本机的 4567 端口号: nc 192.168.198.30 4567
    和上面类似, 但所有数据都是加密的
# 3.4 实际用途
* 互联网访问本地服务

# 4. 动态端口转发
* ssh -CqTnNf -D host_a_port host_a_user@host_a_ip
* 使用 socks5 服务
```


```
firewall-cmd --list-all
firewall-cmd --list-all-policies
```

## 9. 端口转发
```
# 1. 测试环境: 三台虚拟机
192.168.198.10 -- 以下简称 host-10
192.168.198.20 -- 以下简称 host-20
192.168.198.30 -- 以下简称 host-30

# 2. 问题
1. host-10 上有服务
2. host-20 可以直接访问 host-10 上的服务
3. host-30 无法直接访问 host-10 上的服务
4. host-30 可以直接访问 host-20

# 3. 基础设置
1. host-10 开启防火墙端口号: sudo firewall-cmd --add-port=1234/tcp;
2. host-10 开启防火墙端口号: sudo firewall-cmd --add-port=4567/tcp;
3. host-10 启动服务: nc -lkv 1234
4. host-20 开启防火墙端口号: sudo firewall-cmd --add-port=4567/tcp;

