
## 用户创建和删除
```
select user,host,plugin from mysql.user;            # 1. 查看用户及其加密插件
show variables like 'validate_password%';           # 2. 查看密码要求, 大小写字母, 数字, 特殊字符
create user user@hostname identified by 'password'; # 3. 创建用户
drop user user@hostname;                            # 4. 删除用户
```

## 修改密码
```
set password                  =new_password;         # 修改当前用户的密码 -- 新版本 8.0
set password                  =password('123456');   # 修改其他用户的密码 -- 旧版本 5.7
set password for user@hostname=new_password;         # 修改其他用户的密码
alter user user()        identified by new_password; # 修改当前用户的密码
alter user user@hostname identified by new_password; # 修改其他用户的密码
alter user user@hostname identified with caching_sha2_password by 'new_password';
                                                     # 修改其他用户的密码, 使用新版本 8.0 的加密插件
alter user user@hostname identified with mysql_native_password by 'new_password';
                                                     # 修改其他用户的密码, 使用旧版本 5.7 的加密插件
```

## 忘记 root 密码 ----- MariaDB 5.5.68
```
sudo systemctl stop mariadb;            # 1. 停止服务器
sudo mysqld_safe --skip-grant-tables &  # 2. 启动服务器, 跳过密码和权限判断
mysql -u root;                          # 3. 连接 MySQL, 不需要密码
flush privileges;                       # 4. 刷新权限, 使得权限管理生效
set password for 'root'@'localhost' = password('root');
                                        # 5. 设置新密码
mysqladmin -u root -p shutdown;         # 6. 使用新密码停止服务
sudo systemctl start mariadb;           # 7. 启动服务
```

## 忘记 root 密码 ----- MySQL 8.0.39
```
sudo systemctl stop mysql;              # 1. 停止服务器
sudo mkdir -p /var/run/mysqld           # 2. 新建目录(非必须)
sudo chown mysql:mysql /var/run/mysqld  # 3. 改变归属(非必须)
sudo mysqld_safe --skip-grant-tables &  # 4. 启动服务器, 跳过密码和权限判断
mysql -u root;                          # 5. 连接 MySQL, 不需要密码
flush privileges;                       # 6. 刷新权限, 使得权限管理生效
alter user 'root'@'localhost' identified with caching_sha2_password by 'root';
                                        # 7. 设置新密码
mysqladmin -u root -p shutdown;         # 8. 使用新密码停止服务
sudo systemctl start mysql;             # 9. 启动服务
```

## 权限使用原则
* 只赋予满足要求的最小权限
* 限制用户登录的主机, root 只允许本机登录
* 定期删除不用的用户
* 权限可以叠加

## 权限刷新
* 服务端
    * GRANT, REVOKE, SET PASSWORD, RENAME USER --- 不需要刷新权限
    * INSERT, UPDATE, or DELETE -------------------- 需要刷新权限 FLUSH PRIVILEGES --- 不推荐
* 客户端
    * 表和列的权限, 下一次请求的时候就会生效
    * 库的权限, 客户端使用 use ... 的时候才生效, 但客户端可能缓存库名称
    * 密码那些不会影响到已连接的客户端
* 修改权限后, 客户端最好重连

## 直接授予和回收用户权限
```
show privileges;                                           # 查看所有权限
grant select,insert,delete,update on *.* to user@hostname; # 授予用户 增删改查 权限
grant all privileges              on *.* to user@hostname; # 授予用户全部权限, 除 grant
grant all privileges              on *.* to user@hostname with grant option;
                                                           # 授予用全部权限
show grants;                                               # 查看当前用户权限
show grants for user@hostname;                             # 查看其他用户权限
revoke 权限 on *.* from user@hostname;                     # 回收用户权限
```

## 恢复 root 权限
```
sudo systemctl stop mysql;              # 1. 停止服务器
sudo mkdir -p /var/run/mysqld           # 2. 新建目录(非必须)
sudo chown mysql:mysql /var/run/mysqld  # 3. 改变归属(非必须)
sudo mysqld_safe --skip-grant-tables &  # 4. 启动服务器, 跳过密码和权限判断
mysql -u root;                          # 5. 连接 MySQL, 不需要密码
flush privileges;                       # 6. 刷新权限, 使得权限管理生效
grant all privileges on *.* to 'root'@'localhost' with grant option;
                                        # 7. 赋予权限
mysqladmin -u root -p shutdown;         # 8. 使用新密码停止服务
sudo systemctl start mysql;             # 9. 启动服务
```

## 创建和删除角色
```
create role role@hostname;                                  # 创建角色
drop role role@hostname;                                    # 删除角色
```

## 授予和回收角色权限
```
show privileges;                                           # 查看所有权限
grant select,insert,delete,update on *.* to role@hostname; # 授予角色 增删改查 权限
grant all privileges              on *.* to role@hostname; # 授予角色全部权限, 除 grant
grant all privileges              on *.* to role@hostname with grant option;
                                                           # 授予角色全部权限
show grants for role@hostname;                             # 查看角色权限
revoke 权限 on *.* from role@hostname;                     # 回收角色权限
```

## 通过角色赋予和删除用户权限
```
grant  role to   user;                                      # 1. 将角色赋予用户
set default role all to user@hostname;                      # 2. 激活权限
revoke role from user;                                      # 3. 撤销用户角色
```

## 参考资源
* https://dev.mysql.com/doc/refman/9.0/en/account-management-statements.html --- 用户和角色
* https://dev.mysql.com/doc/refman/9.0/en/privilege-changes.html --------------- 权限刷新
* https://dev.mysql.com/doc/refman/9.0/en/resetting-permissions.html ----------- 重置 root 密码

