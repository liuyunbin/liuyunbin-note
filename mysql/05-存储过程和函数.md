
## 1. 存储过程
### 1.1 优缺点
```
* 提前编译, 效率高
* 简化操作
* 提高复用
* 减少操作失误
* 减少网上传输的数据
* 提高了数据安全 
* 没返回值
* 不好调试
* 分表时, 不好维护
* 跨数据库不好移植
* 不好做版本管理
```

### 1.2 说明
```
DELIMITER $
CREATE PROCEDURE procedure_name(...) ------- IN, OUT, INOUT
[characteristics ...]
BEGIN
    ...
END $
DELIMITER ;

characteristics:
* LANGUAGE SQL ----------- 语言 SQL
* DETERMINISTIC ---------- 相同的输入会得到相同的输出
* NOT DETERMINISTIC ------ 相同的输入不一定会得到相同的输出 ---- 默认值
* NO SQL ----------------- 不包含任何 SQL 语句
* CONTAINS SQL ----------- 不包含任何 SQL 语句, 但是并不包含读写数据的SQL语句 ---- 默认
* READS SQL DATA --------- 包含读数据的 SQL 语句
* MODIFIES SQL DATA ------ 包含写数据的 SQL 语句
* SQL SECURITY DEFINER --- 只允许创建者或定义者使用 --- 默认
* SQL SECURITY INVOKER --- 允许所有人使用
* COMMENT string --------- 注释信息

CALL procedure_name(...)
```

### 1.3 示例
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
    SELECT 123;
END $
DELIMITER ;

CALL  procedure_name();
SHOW  CREATE PROCEDURE procedure_name;
```

## 2. 函数
### 2.1 和存储过程的区别
```
* 有返回值
* 参数只能是 IN
* 需要设置: SET GLOBAL log_bin_trust_function_creators = 1
```

### 2.2 说明
```
DELIMITER $
CREATE FUNCTION function_name(...)
[characteristics ...]
RETURNS ...
BEGIN
   ...
END $
DELIMITER ;

SELECT procedure_name(...)
```

### 2.3 实例
```
SET GLOBAL log_bin_trust_function_creators = 1; # 使用 root 用户或有权限的用户设置

DROP FUNCTION  IF EXISTS function_name;
DELIMITER $
CREATE FUNCTION function_name()
RETURNS INT
BEGIN
   RETURN 123;
END $
DELIMITER ;

SELECT function_name();
SHOW CREATE FUNCTION function_name;
```

## 3. 变量
### 3.1 全局系统变量
```
SHOW   GLOBAL  VARIABLES LIKE 'character%';    # 查询全局系统变量
SELECT @@GLOBAL.character_set_client;          # 查询全局系统变量
SET    @@global.character_set_client = 变量值;       # 设置全局系统变量 -- 不能跨服务器重启
SET            GLOBAL character_set_client = 变量值; # 设置全局系统变量 -- 不能跨服务器重启
SET    PERSIST GLOBAL character_set_client = 变量值; # 设置全局系统变量 -----能跨服务器重启
```

### 3.2 会话系统变量
```
* 初始值可以从全局系统变量拷贝

SHOW   SESSION VARIABLES LIKE 'character%';     # 查询会话系统变量
SELECT @@SESSION.character_set_client;          # 查询会话系统变量
SET    @@session.character_set_client = 变量值; # 设置会话系统变量
SET    SESSION   character_set_client = 变量值; # 设置会话系统变量
```

### 3.3 会话用户变量
```
USE    test;
DROP   TABLE IF EXISTS student;
CREATE TABLE student (id INT);
SET    @num = 100;                      # 设置会话用户变量
SELECT @num;                            # 查看会话用户变量
SELECT count(*) INTO @num FROM student; # 设置会话用户变量
SELECT @num;                            # 查看会话用户变量
```

### 3.4 局部变量
```
* 只在BEGIN 和 END 之间使用, 定义只能放在开头
* 需要指定类型
* DECLARE 定义
```

### 3.5 测试
#### 3.5.1: SET SELECT
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
    DECLARE num  int;
    SET     num  = 10;
    SELECT  num;
END $
DELIMITER ;

CALL procedure_name()
```

#### 3.5.2: SET DEFAULT SELECT
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
    DECLARE num  int DEFAULT 100;
    SELECT  num;
    SET     num  = 10;
    SELECT  num;
END $
DELIMITER ;

CALL procedure_name()
```

#### 3.5.3: SELECT INTO
```
USE    test;
DROP   TABLE IF EXISTS student;
CREATE TABLE student (id INT);
    
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
    DECLARE num int;
    SELECT count(*) INTO num FROM student;
    SELECT  num;
END $
DELIMITER ;

CALL procedure_name()
```

#### 3.5.4 : 混用局部变量和用户会话变量
```
USE    test;
DROP   TABLE IF EXISTS student;
CREATE TABLE student (id INT);
    
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name(OUT num int)
BEGIN
    SELECT count(*) INTO num FROM student;
END $
DELIMITER ;

SET    @num = 10;
SELECT @num;
CALL   procedure_name(@num);
SELECT @num;
```

## 4. 流程控制
### 4.1 语句: IF
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
  DECLARE num INT;
  SET num = 3;
  IF num = 1 THEN
    select "num 1", num;
  ELSEIF num = 2 THEN
    select "num 2", num;
  ELSE
    select "num 3", num;
  END IF;
END $
DELIMITER ;

CALL procedure_name();
```

### 4.2 语句: CASE (情况一: 类似 switch)
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
  DECLARE num INT;
  SET num = 3;
  CASE num
	WHEN 1 THEN
    select "num 1", num;
  WHEN 2 THEN
    select "num 2", num; 
	ELSE
    select "num 3", num; 
  END CASE;
END $
DELIMITER ;

CALL procedure_name();
```

### 4.2 语句: CASE (情况二)
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
  DECLARE num INT;
  SET num = 3;
  CASE
	WHEN num = 1 THEN
    select "num 1", num;
  WHEN num = 2 THEN
    select "num 2", num; 
	ELSE
    select "num 3", num; 
  END CASE;
END $
DELIMITER ;

CALL procedure_name();
```
  
### 4.3 语句: LOOP
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
  DECLARE id INT DEFAULT 0;
  add_loop: LOOP
    SET id = id +1;
    IF id > 3 THEN
      LEAVE add_loop;
    ELSE
      select id;
    END IF;
  END LOOP add_loop;
END $
DELIMITER ;

CALL procedure_name();
```

### 4.4 语句: WHILE
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
  DECLARE i INT DEFAULT 0;
	
	add_while: WHILE i < 10 DO
		SET i = i + 1;
	END WHILE add_while;
	
	SELECT i;
END $
DELIMITER ;

CALL procedure_name();
```

### 4.5 语句: REPEAT (类似 do ... while)
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
  DECLARE i INT DEFAULT 0;
    
  add_repeat: REPEAT 
		SET i = i + 1;
	UNTIL i >= 10
	END REPEAT add_repeat;
	
	SELECT i;
END $
DELIMITER ;

CALL procedure_name();
```

### 4.6 语句: ITERATE(与 continue 类似)
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
  DECLARE id INT DEFAULT 0;
  add_loop: LOOP
    SET id = id +1;
    IF id < 10 THEN
      ITERATE add_loop;
    ELSEIF id > 13 THEN
      LEAVE add_loop;
    END IF;
    
    select id;
  END LOOP add_loop;
END $
DELIMITER ;

CALL procedure_name();
```

### 4.7 语句: LEAVE(与 break 类似)
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
  DECLARE id INT DEFAULT 0;
  add_loop: LOOP
    SET id = id +1;
    IF id > 3 THEN
      LEAVE add_loop;
    ELSE
      select id;
    END IF;
  END LOOP add_loop;
END $
DELIMITER ;

CALL procedure_name();
```
