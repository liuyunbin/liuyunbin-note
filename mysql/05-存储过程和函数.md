
## 1. 变量
### 1.1 系统变量
```
* 全局变量
* 会话变量
* 有的变量既是全局变量, 又是会话变量
* 默认是 会话变量

SHOW GLOBAL  VARIABLES LIKE 'character%'; # 查询全局变量
SHOW SESSION VARIABLES LIKE 'character%'; # 查询会话变量
SHOW         VARIABLES LIKE 'character%'; # 查询会话变量

SELECT @@GLOBAL.character_set_client;  # 查询全局变量
SELECT @@SESSION.character_set_client; # 查询会话变量
SELECT @@character_set_client;         # 先查会话变量, 再查全局变量

SET @@global.character_set_client = 变量值; # 设置全局变量
SET GLOBAL   character_set_client = 变量值; # 设置全局变量

SET @@session.character_set_client = 变量值; # 设置会话变量
SET SESSION   character_set_client = 变量值; # 设置会话变量
```

### 1.2 用户变量
#### 1.2.1 会话用户变量
```
USE    test;
DROP   TABLE IF EXISTS student;
CREATE TABLE student (id INT);
SET    @num = 100;                      # 设置会话用户变量
SELECT @num;                            # 查看会话用户变量
SELECT count(*) INTO @num FROM student; # 设置会话用户变量
SELECT @num;                            # 查看会话用户变量
```

#### 1.2.2 局部变量
* 只在存储过程和函数中使用, 定义只能放在开头
* 需要指定类型

##### 1.2.2.1 测试一 (SET SELECT)
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
    DECLARE num  int;   # 定义
    SET     num  = 10;
    SELECT  num;
END $
DELIMITER ;

CALL procedure_name()
```

##### 1.2.2.2 测试二 (SET DEFAULT SELECT)
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
    DECLARE num  int DEFAULT 100;   # 定义
    SELECT  num;
    SET     num  = 10;
    SELECT  num;
END $
DELIMITER ;

CALL procedure_name()
```

##### 1.2.2.3 测试三 (SELECT INTO)
```
USE    test;
DROP   TABLE IF EXISTS student;
CREATE TABLE student (id INT);
    
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
    DECLARE num int;   # 定义
    select count(*) into num FROM student;
    SELECT  num;
END $
DELIMITER ;

CALL procedure_name()
```

##### 1.2.2.4 测试四 (混用局部变量和用户会话变量)
```
USE    test;
DROP   TABLE IF EXISTS student;
CREATE TABLE student (id INT);
    
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name(OUT num int)
BEGIN
    select count(*) into num FROM student;
END $
DELIMITER ;

SET @num = 10;
SELECT @num;
CALL procedure_name(@num);
SELECT @num;
```

## 2. 存储过程
### 2.1 优缺点
* 简化操作, 减少网上传输的数据
* 提高复用, 减少操作失误
* 提高了数据安全 
* 提前编译, 效率高
* 没返回值
* 不好调试
* 分表时, 不好维护
* 跨数据库不好移植
* 不好做版本管理

### 2.2 说明
```
DELIMITER $
CREATE PROCEDURE procedure_name(...) ------- IN, OUT, INOUT
[characteristics ...]
BEGIN
    ...
END $
DELIMITER ;

characteristics
* LANGUAGE SQL ----------- 语言 SQL
* DETERMINISTIC ---------- 相同的输入会得到相同的输出
* NOT DETERMINISTIC ------ 相同的输入不一定会得到相同的输出 ---- 默认值
* NO SQL ----------------- 不包含任何 SQL 语句
* CONTAINS SQL ----------- 不包含任何 SQL 语句, 但是并不包含读写数据的SQL语句 ---- 默认
* READS SQL DATA --------- 包含读数据的 SQL 语句
* MODIFIES SQL DATA ------ 包含写数据的 SQL 语句
* SQL SECURITY DEFINER --- 只允许创建者或定义者使用 --- 默认
* SQL SECURITY INVOKER --- 允许所有人使用
* COMMENT string --------- 注释信息

CALL procedure_name(...)
```

## 3. 函数
### 3.1 和存储过程的区别
```
* 有返回值
* 参数只能是 IN
* characteristics 需要指定: DETERMINISTIC 或 CONTAINS SQL 或 NO SQL

SHOW CREATE FUNCTION ...
SHOW FUNCTION STATUS LIKE ...

ALTER {PROCEDURE | FUNCTION} 存储过程或函数的名 [characteristic ...]


DELIMITER $
create function function_name(...) --- 只能是 IN
    [characteristics ...]
    return ...
    begin
        ...
    end $
DELIMITER ;

select procedure_name(...)


drop function            function_name;               # 删除函数
drop procedure          procedure_name;               # 删除存储过程
```

## 4. 流程控制
### 4.1  语句: IF
```
DROP PROCEDURE IF EXISTS procedure_name;
DELIMITER $
CREATE PROCEDURE procedure_name()
BEGIN
  DECLARE num INT;
  SET num = 3;
  IF num = 1 THEN
    select "num 1", num;
  ELSEIF num = 2 THEN
    select "num 2", num;
  ELSE
    select "num 3", num;
  END IF;
END $
DELIMITER ;

CALL procedure_name();
```

### 语句: CASE
### 语句: LOOP
### 语句: WHILE
### 语句: REPEAT
### 语句: ITERATE
### 语句: LEAVE

round -- 不一定是直观 的四舍五入

current_timestamp()
current_date()
now()
