
## 0. 事务基础: ACID
```
* 原子性
* 一致性: 执行事务后的状态合法
* 隔离型: 事务之间不受影响
* 持久性: 持久保存到文件
```

## 1. 隐式事务
```
* DML: autocommit = ON 且 未显示开启事务
```

## 2. 显示事务
```
DROP TABLE if EXISTS student;
CREATE TABLE student(name varchar(20) UNIQUE);

# 2.1 使用 BEGIN 开启事务
TRUNCATE student;                   # 1. 清空表
BEGIN;                              # 2. 开启事务
INSERT INTO student VALUES('张三'); # 3. 不提交
SELECT * FROM student;              # 4. 当前事务: 张三
SELECT * FROM student;              # 5. 其他会话: 空表
COMMIT;                             # 6. 提交事务
SELECT * FROM student;              # 7. 当前会话: 张三
SELECT * FROM student;              # 8. 其他会话: 张三

# 2.2 使用 START TRANSACTION 开启事务 (读写事务)
TRUNCATE student;                   # 1. 清空表
START TRANSACTION;                  # 2. 开启事务
INSERT INTO student VALUES('张三'); # 3. 不提交
SELECT * FROM student;              # 4. 当前事务: 张三
SELECT * FROM student;              # 5. 其他会话: 空表
COMMIT;                             # 6. 提交事务
SELECT * FROM student;              # 7. 当前会话: 张三
SELECT * FROM student;              # 8. 其他会话: 张三

# 2.3 测试普通回滚
TRUNCATE student;                   #  1. 清空表
START TRANSACTION;                  #  2. 开启事务
INSERT INTO student VALUES('张三'); #  3. 不提交
INSERT INTO student VALUES('李四'); #  4. 不提交
SELECT * FROM student;              #  5. 当前事务: 张三 李四
SELECT * FROM student;              #  6. 其他会话: 空表
ROLLBACK;                           #  7. 回滚
SELECT * FROM student;              #  8. 当前事务: 空表
SELECT * FROM student;              #  9. 其他会话: 空表
COMMIT;                             # 10. 提交事务
SELECT * FROM student;              # 11. 当前会话: 空表
SELECT * FROM student;              # 12. 其他会话: 空表

# 2.4 测试: 设置回滚点 SAVEPOINT
TRUNCATE student;                   #  1. 清空表
START TRANSACTION;                  #  2. 开启事务
INSERT INTO student VALUES('张三'); #  3. 不提交
SAVEPOINT p1;                       #  4. 设置回滚点
INSERT INTO student VALUES('李四'); #  5. 不提交
SELECT * FROM student;              #  6. 当前事务: 张三 李四
SELECT * FROM student;              #  7. 其他会话: 空表
ROLLBACK TO p1;                     #  8. 回滚到 p1
SELECT * FROM student;              #  9. 当前事务: 张三
SELECT * FROM student;              # 10. 其他会话: 空表
RELEASE SAVEPOINT p1;               # 11. 删除保存点
COMMIT;                             # 12. 提交事务
SELECT * FROM student;              # 13. 当前会话: 张三
SELECT * FROM student;              # 14. 其他会话: 张三

# 2.5 测试对后续命令的处理: completion_type = 0 (默认)
* 如果 autocommit = ON, 会自动提交
* 否则, 需要手动提交 COMMIT

SET SESSION autocommit      = ON;
SET SESSION completion_type = 0;
TRUNCATE student;                   #  1. 清空表
START TRANSACTION;                  #  2. 开启事务
INSERT INTO student VALUES('张三'); #  3. 不提交
SELECT * FROM student;              #  4. 当前事务: 张三
SELECT * FROM student;              #  5. 其他会话: 空表
COMMIT;                             #  6. 提交事务
SELECT * FROM student;              #  7. 当前会话: 张三
SELECT * FROM student;              #  8. 其他会话: 张三
INSERT INTO student VALUES('李四'); #  9. 提交, 因为 autocommit = ON
SELECT * FROM student;              # 10. 当前会话: 张三 李四
SELECT * FROM student;              # 11. 其他会话: 张三 李四

SET SESSION autocommit      = OFF;
SET SESSION completion_type = 0;
TRUNCATE student;                   #  1. 清空表
START TRANSACTION;                  #  2. 开启事务
INSERT INTO student VALUES('张三'); #  3. 不提交
SELECT * FROM student;              #  4. 当前事务: 张三
SELECT * FROM student;              #  5. 其他会话: 空表
COMMIT;                             #  6. 提交事务
SELECT * FROM student;              #  7. 当前会话: 张三
SELECT * FROM student;              #  8. 其他会话: 张三
INSERT INTO student VALUES('李四'); #  9. 不提交, 因为 autocommit = OFF
SELECT * FROM student;              # 10. 当前事务: 张三 李四
SELECT * FROM student;              # 11. 其他会话: 张三
COMMIT;                             # 12. 提交事务
SELECT * FROM student;              # 13. 当前会话: 张三 李四
SELECT * FROM student;              # 14. 其他会话: 张三 李四

# 2.6 测试对后续命令的处理: completion_type = 1
* 开启链式事务
* 后续的命令需要手动提交

SET SESSION autocommit      = ON;
SET SESSION completion_type = 1;
TRUNCATE student;                   #  1. 清空表
START TRANSACTION;                  #  2. 开启事务
INSERT INTO student VALUES('张三'); #  3. 不提交
SELECT * FROM student;              #  4. 当前事务: 张三
SELECT * FROM student;              #  5. 其他会话: 空表
COMMIT;                             #  6. 提交事务
SELECT * FROM student;              #  7. 当前会话: 张三
SELECT * FROM student;              #  8. 其他会话: 张三
INSERT INTO student VALUES('李四'); #  9. 不提交
SELECT * FROM student;              # 10. 当前事务: 张三 李四
SELECT * FROM student;              # 11. 其他会话: 张三
COMMIT;                             # 12. 提交事务
SELECT * FROM student;              # 13. 当前会话: 张三 李四
SELECT * FROM student;              # 14. 其他会话: 张三 李四

SET SESSION autocommit      = OFF;
SET SESSION completion_type = 1;
TRUNCATE student;                   #  1. 清空表
START TRANSACTION;                  #  2. 开启事务
INSERT INTO student VALUES('张三'); #  3. 不提交
SELECT * FROM student;              #  4. 当前事务: 张三
SELECT * FROM student;              #  5. 其他会话: 空表
COMMIT;                             #  6. 提交事务
SELECT * FROM student;              #  7. 当前会话: 张三
SELECT * FROM student;              #  8. 其他会话: 张三
INSERT INTO student VALUES('李四'); #  9. 不提交
SELECT * FROM student;              # 10. 当前事务: 张三 李四
SELECT * FROM student;              # 11. 其他会话: 张三
COMMIT;                             # 12. 提交事务
SELECT * FROM student;              # 13. 当前会话: 张三 李四
SELECT * FROM student;              # 14. 其他会话: 张三 李四

# 2.7 测试对后续命令的处理: completion_type = 2
* 提交后, 与服务器断开
* 使用终端测试

SET SESSION completion_type = 2;
TRUNCATE student;                   # 1. 清空表
START TRANSACTION;                  # 2. 开启事务
INSERT INTO student VALUES('张三'); # 3. 不提交
SELECT * FROM student;              # 4. 当前事务: 张三
SELECT * FROM student;              # 5. 其他会话: 空表
COMMIT;                             # 6. 提交事务, 然后断开连接
SELECT * FROM student;              # 7. 当前会话: 报错
SELECT * FROM student;              # 8. 其他会话: 张三

# 2.8 使用 START TRANSACTION READ WRITE -- 读写事务
TRUNCATE student;                   # 1. 清空表
START TRANSACTION READ WRITE;       # 2. 开启事务
INSERT INTO student VALUES('张三'); # 3. 不提交
SELECT * FROM student;              # 4. 当前事务: 张三
SELECT * FROM student;              # 5. 其他会话: 空表
COMMIT;                             # 6. 提交事务
SELECT * FROM student;              # 7. 当前会话: 张三
SELECT * FROM student;              # 8. 其他会话: 张三

# 2.9 使用 START TRANSACTION READ ONLY -- 只读事务
* 只读指对于其他事务能访问的资源, 不包括临时表

TRUNCATE student;                   # 1. 清空表
START TRANSACTION READ ONLY;        # 2. 开启事务
INSERT INTO student VALUES('张三'); # 3. 报错, 因为该事务只读
SELECT * FROM student;              # 4. 当前事务: 空表
SELECT * FROM student;              # 5. 其他会话: 空表
COMMIT;                             # 6. 提交事务
SELECT * FROM student;              # 7. 当前会话: 空表
SELECT * FROM student;              # 8. 其他会话: 空表

# 2.10 使用 START TRANSACTION WITH CONSISTENT SNAPSHOT -- 一致性读
* 建立事务的时候, 会快照所有的表
* 避免了 脏读 不可重复读 幻读 问题

# 2.10.1 测试使用一致性读 (开启事务时, 快照所有表)

TRUNCATE student;                                       #  1. 清空表
INSERT INTO student VALUES('张三');                     #  2. 插入数据
INSERT INTO student VALUES('李四');                     #
INSERT INTO student VALUES('王五');                     #
SELECT * FROM student;                                  #  3. 查看数据
START TRANSACTION  WITH CONSISTENT SNAPSHOT;            #  4. 开启事务, 此时, 快照所有表
UPDATE student SET name = '张六' WHERE name = '张三';   #  5. 其他会话: 更新数据
SELECT * FROM student;                                  #  6. 其他会话: 张六 李四 王五
SELECT * FROM student;                                  #  7. 当前事务: 张三 李四 王五, 使用快照表中的数据
COMMIT;                                                 #  8. 提交事务
SELECT * FROM student;                                  #  9. 其他会话: 张六 李四 王五
SELECT * FROM student;                                  # 10. 当前会话: 张六 李四 王五, 变成修改后的数据

# 2.10.2 测试不使用一致性读 (调用 SELECT 时, 快照对应的表)
TRUNCATE student;                                       #  1. 清空表
INSERT INTO student VALUES('张三');                     #  2. 插入数据
INSERT INTO student VALUES('李四');                     #
INSERT INTO student VALUES('王五');                     #
SELECT * FROM student;                                  #  3. 查看数据
START TRANSACTION;                                      #  4. 开启事务
UPDATE student SET name = '张六' WHERE name = '张三';   #  5. 其他会话: 更新数据
SELECT * FROM student;                                  #  6. 其他会话: 张六 李四 王五
SELECT * FROM student;                                  #  7. 当前事务: 张六 李四 王五, 此时, 快照该表
UPDATE student SET name = '张七' WHERE name = '张六';   #  8. 其他会话: 更新数据
SELECT * FROM student;                                  #  9. 其他会话: 张七 李四 王五
SELECT * FROM student;                                  # 10. 当前事务: 张六 李四 王五, 使用快照数据
COMMIT;                                                 # 11. 提交事务
SELECT * FROM student;                                  # 12. 其他会话: 张七 李四 王五
SELECT * FROM student;                                  # 13. 当前会话: 张七 李四 王五
```

## 3. 隐式提交之前的事务
```
* DDL
* 修改密码或权限
* 开启新事务
* AUTOCOMMIT OFF -> ON
* 使用锁语句
* 数据库加载新数据
* 使用主从复制
```
