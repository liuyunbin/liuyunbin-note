
## 0. 准备数据
```
DROP TABLE if EXISTS student;
CREATE TABLE student(id INT, name varchar(20));
```

## 1. 脏写
* 事务一更新数据, 还未提交
* 事务二更新数据, 提交
* 事务一回滚, 此时, 事务一更新的数据丢失了
* 实际情况不可能发生, 会等待

| 会话A                                  | 会话B                  | 说明                      |
| -------------------------------------- | ---------------------- | --------                  |
| TRUNCATE student;                      |                        | 清空表                    |
| INSERT INTO student VALUES(1, '张三'); |                        | 插入数据                  |
| START TRANSACTION;                     |                        | 开启事务                  |
| SELECT * FROM student;                 |                        | 张三                      |
| UPDATE student SET name = '张六' WHERE id = 1; |                | 更新数据                  |
| SELECT * FROM student;                 |                        | 张六                      |
|                                        | START TRANSACTION;     | 开启事务                  |
|                                        | SELECT * FROM student; | 张三                      |
|         | UPDATE student SET name = '张七' WHERE id = 1;        | 更新数据   -- 实际会等待  |
|                                        | SELECT * FROM student; | 张七                      |
|                                        | COMMIT;                | 提交事务                  |
| ROLLBACK;                              |                        | 回滚, 丢失了 会话B 的修改 |
| COMMIT;                                |                        | 提交事务                  |
| SELECT * FROM student;                 |                        | 张三                      |
|                                        | SELECT * FROM student; | 张三                      |


## 2. 脏读
### 2.1 测试 READ UNCOMMITTED
| 会话A                                  | 会话B                  | 说明                      |
| -------------------------------------- | ---------------------- | --------                  |
SET SESSION TRANSACTION_ISOLATION = 'REPEATABLE-READ'; #  4. 所有会话: 设置隔离级别

| TRUNCATE student;                      |                        | 清空表                    |
| INSERT INTO student VALUES(1, '张三'); |                        | 插入数据                  |
| START TRANSACTION;                     |                        | 开启事务                  |
| SELECT * FROM student;                 |                        | 张三                      |
| UPDATE student SET name = '张六' WHERE id = 1; |                | 更新数据                  |
| SELECT * FROM student;                 |                        | 张六                      |
|                                        | START TRANSACTION;     | 开启事务                  |
|                                        | SELECT * FROM student; | 张三                      |
|         | UPDATE student SET name = '张七' WHERE id = 1;        | 更新数据   -- 实际会等待  |
|                                        | SELECT * FROM student; | 张七                      |
|                                        | COMMIT;                | 提交事务                  |
| ROLLBACK;                              |                        | 回滚, 丢失了 会话B 的修改 |
| COMMIT;                                |                        | 提交事务                  |
| SELECT * FROM student;                 |                        | 张三                      |
|                                        | SELECT * FROM student; | 张三                      |



    1. 事务一更新数据, 还未提交
    2. 事务二读取到更新过的数据
    3. 事务一回滚, 此时, 事务二读取的数据就是脏的
* 不可重复读 ---  由于 其他事务删除和更新 导致的问题
    1. 事务一读取数据
    2. 会话B 更新相关数据
    3. 事务一再次读取数据, 数据不一致
* 幻读 --- 由于 其他事务插入 导致的问题
    1. 事务一读取数据
    2. 会话B 插入数据
    3. 事务一再次读取数据, 数据不一致
* 严重性: 脏写 > 脏读 > 不可重复读 > 幻读
```

## 2. 四种隔离级别
```
* READ UNCOMMITTED
    * 可以看到其他未提交事务的执行结果
    * 不能避免脏读、不可重复读、幻读 
* READ COMMITTED
    * 只能看见已经提交事务所做的改变
    * 可以避免脏读，但不可重复读、幻读问题仍然存在
* REPEATABLE READ: 可重复读
    * 事务A在读到一条数据之后，此时事务B对该数据进行了修改并提交
    * 那么事务A再读该数据，读到的还是原来的内容
    * 可以避免脏读、不可重复读，但幻读问题仍然存在
    * MySQL 可以处理不可重复读
        * 旧数据可以满足需求, 使用 MVCC 即可
        * 旧数据不可以满足需求, 使用 记录锁 即可
    * MySQL 可以处理幻读
        * 旧数据可以满足需求, 使用 MVCC 即可
        * 旧数据不可以满足需求, 使用 记录锁和间隙锁 即可
    * 这是 MySQL 的默认隔离级别
* SERIALIZABLE: 可串行化，确保事务可以从一个表中读取相同的行
    * 事务持续期间，禁止其他事务对该行执行插入、更新和删除操作
    * 性能十分低下
    * 能避免脏读、不可重复读和幻读
    * 相当于对 SELECT 语句增加 共享锁

SELECT  @@GLOBAL.TRANSACTION_ISOLATION; # 查看隔离级别
SELECT @@SESSION.TRANSACTION_ISOLATION; # 查看隔离级别

SET GLOBAL TRANSACTION_ISOLATION = 'READ-UNCOMMITTED'; # 设置隔离级别
SET GLOBAL TRANSACTION_ISOLATION = 'READ-COMMITTED';   # 设置隔离级别
SET GLOBAL TRANSACTION_ISOLATION = 'REPEATABLE-READ';  # 设置隔离级别
SET GLOBAL TRANSACTION_ISOLATION = 'SERIALIZABLE';     # 设置隔离级别

SET SESSION TRANSACTION_ISOLATION = 'READ-UNCOMMITTED'; # 设置隔离级别
SET SESSION TRANSACTION_ISOLATION = 'READ-COMMITTED';   # 设置隔离级别
SET SESSION TRANSACTION_ISOLATION = 'REPEATABLE-READ';  # 设置隔离级别
SET SESSION TRANSACTION_ISOLATION = 'SERIALIZABLE';     # 设置隔离级别
```

## 3. 测试
```
DROP TABLE if EXISTS student;
CREATE TABLE student(id INT PRIMARY KEY, name varchar(20));

# 3.1 测试 READ UNCOMMITTED (未处理 脏读 不可重复读 幻读)
TRUNCATE student;                                       #  1. 清空表
INSERT INTO student VALUES(1, '张一');                  #  2. 初始化数据
INSERT INTO student VALUES(2, '张二');                  #
SET SESSION TRANSACTION_ISOLATION = 'READ-UNCOMMITTED'; #  3. 其他会话: 设置隔离级别
SET SESSION TRANSACTION_ISOLATION = 'READ-UNCOMMITTED'; #  4. 当前会话: 设置隔离级别
SELECT * FROM student;                                  #  5. 查看数据
START TRANSACTION;                                      #  6. 开启事务
INSERT INTO student VALUES(3, '张三');                  #  7. 不提交
SELECT * FROM student WHERE id = 3;                     #  8. 当前事务: 张三
SELECT * FROM student WHERE id = 3;                     #  9. 其他会话: 张三, 可以读取到未提交的数据
ROLLBACK;                                               # 10. 回滚
SELECT * FROM student WHERE id = 3;                     # 11. 当前事务: 空表
SELECT * FROM student WHERE id = 3;                     # 12. 其他会话: 空表, 之前读取的 张三 是 脏读
SELECT * FROM student WHERE id = 1;                     # 13. 当前会话: 张一
SELECT * FROM student WHERE id = 1;                     # 14. 其他会话: 张一
UPDATE student SET name = '张六' WHERE id = 1;          # 15. 其他会话: 修改数据
SELECT * FROM student WHERE id = 1;                     # 16. 其他会话: 张六             
SELECT * FROM student WHERE id = 1;                     # 17. 当前会话: 张六 (不可重复读)
SELECT * FROM student WHERE id >= 1;                    # 18. 当前会话: 张六 张二
SELECT * FROM student WHERE id >= 1;                    # 19. 其他会话: 张六 张二
INSERT INTO student VALUES(3, '张三');                  # 20. 其他会话: 添加数据
SELECT * FROM student WHERE id >= 1;                    # 21. 其他会话: 张六 张二 张三
SELECT * FROM student WHERE id >= 1;                    # 22. 当前会话: 张六 张二 张三 (幻读)
COMMIT;                                                 # 23. 提交事务

# 3.2 测试 READ COMMITTED (处理了 脏读, 未处理 不可重复读, 幻读)
TRUNCATE student;                                       #  1. 清空表
INSERT INTO student VALUES(1, '张一');                  #  2. 初始化数据
INSERT INTO student VALUES(2, '张二');                  #
SET SESSION TRANSACTION_ISOLATION = 'READ-COMMITTED';   #  3. 其他会话: 设置隔离级别
SET SESSION TRANSACTION_ISOLATION = 'READ-COMMITTED';   #  4. 当前会话: 设置隔离级别
SELECT * FROM student;                                  #  5. 查看数据
START TRANSACTION;                                      #  6. 开启事务
INSERT INTO student VALUES(3, '张三');                  #  7. 不提交
SELECT * FROM student WHERE id = 3;                     #  8. 当前事务: 张三
SELECT * FROM student WHERE id = 3;                     #  9. 其他会话: 空表, 不能读取到未提交的数据
ROLLBACK;                                               # 10. 回滚
SELECT * FROM student WHERE id = 3;                     # 11. 当前事务: 空表
SELECT * FROM student WHERE id = 3;                     # 12. 其他会话: 空表, 不存在 脏读
SELECT * FROM student WHERE id = 1;                     # 13. 当前会话: 张一
SELECT * FROM student WHERE id = 1;                     # 14. 其他会话: 张一
UPDATE student SET name = '张六' WHERE id = 1;          # 15. 其他会话: 修改数据
SELECT * FROM student WHERE id = 1;                     # 16. 其他会话: 张六             
SELECT * FROM student WHERE id = 1;                     # 17. 当前会话: 张六 (不可重复读)
SELECT * FROM student WHERE id >= 1;                    # 18. 当前会话: 张六 张二
SELECT * FROM student WHERE id >= 1;                    # 19. 其他会话: 张六 张二
INSERT INTO student VALUES(3, '张三');                  # 20. 其他会话: 添加数据
SELECT * FROM student WHERE id >= 1;                    # 21. 其他会话: 张六 张二 张三
SELECT * FROM student WHERE id >= 1;                    # 22. 当前会话: 张六 张二 张三 (幻读)
COMMIT;                                                 # 23. 提交事务

# 3.3 REPEATABLE READ (处理了 脏读, 不可重复读, 幻读)
# 3.3.1 测试: 处理了 脏读, 不可重复读, 幻读
TRUNCATE student;                                       #  1. 清空表
INSERT INTO student VALUES(1, '张一');                  #  2. 初始化数据
INSERT INTO student VALUES(2, '张二');                  #
SET SESSION TRANSACTION_ISOLATION = 'REPEATABLE-READ';  #  3. 其他会话: 设置隔离级别
SET SESSION TRANSACTION_ISOLATION = 'REPEATABLE-READ';  #  4. 当前会话: 设置隔离级别
SELECT * FROM student;                                  #  5. 查看数据
START TRANSACTION;                                      #  6. 开启事务
INSERT INTO student VALUES(3, '张三');                  #  7. 不提交
SELECT * FROM student WHERE id = 3;                     #  8. 当前事务: 张三
SELECT * FROM student WHERE id = 3;                     #  9. 其他会话: 空表, 不能读取到未提交的数据
ROLLBACK;                                               # 10. 回滚
SELECT * FROM student WHERE id = 3;                     # 11. 当前事务: 空表
SELECT * FROM student WHERE id = 3;                     # 12. 其他会话: 空表, 不存在 脏读
SELECT * FROM student WHERE id = 1;                     # 13. 当前会话: 张一
SELECT * FROM student WHERE id = 1;                     # 14. 其他会话: 张一
UPDATE student SET name = '张六' WHERE id = 1;          # 15. 其他会话: 修改数据
SELECT * FROM student WHERE id = 1;                     # 16. 其他会话: 张六             
SELECT * FROM student WHERE id = 1;                     # 17. 当前会话: 张一 (解决不可重复读)
SELECT * FROM student WHERE id >= 1;                    # 18. 当前会话: 张一 张二
SELECT * FROM student WHERE id >= 1;                    # 19. 其他会话: 张六 张二
INSERT INTO student VALUES(3, '张三');                  # 20. 其他会话: 添加数据
SELECT * FROM student WHERE id >= 1;                    # 21. 其他会话: 张六 张二 张三
SELECT * FROM student WHERE id >= 1;                    # 22. 当前会话: 张一 张二 (解决幻读)
COMMIT;

# 3.3.2 开启事务时, 会对所有张表进行快照
TRUNCATE student;                                       #  1. 清空表
INSERT INTO student VALUES(1, '张一');                  #  2. 初始化数据
INSERT INTO student VALUES(2, '张二');                  #
SET SESSION TRANSACTION_ISOLATION = 'REPEATABLE-READ';  #  3. 当前会话: 设置隔离级别
SELECT * FROM student;                                  #  4. 查看数据
START TRANSACTION WITH CONSISTENT SNAPSHOT;             #  5. 开启事务, 一致性读 (建立快照)
INSERT INTO student VALUES(3, '张三');                  #  6. 其他会话: 添加数据
SELECT * FROM student;                                  #  7. 其他会话: 张一 张二 张三
SELECT * FROM student;                                  #  8. 当前会话: 张一 张二 (使用快照数据)
UPDATE student SET name = '张六' WHERE id = 1;          #  9. 其他会话: 修改数据
SELECT * FROM student;                                  # 10. 其他会话: 张六 张二 张三
SELECT * FROM student;                                  # 11. 当前会话: 张一 张二 (使用快照数据)
DELETE   FROM student WHERE id = 2;                     # 12. 其他会话: 删除数据
SELECT * FROM student;                                  # 13. 其他会话: 张六 张三
SELECT * FROM student;                                  # 14. 当前会话: 张一 张二 (使用快照数据)
COMMIT;

# 3.3.3 第一次 SELECT 时, 会对整张表进行快照
TRUNCATE student;                                       #  1. 清空表
INSERT INTO student VALUES(1, '张一');                  #  2. 初始化数据
INSERT INTO student VALUES(2, '张二');                  #
SET SESSION TRANSACTION_ISOLATION = 'REPEATABLE-READ';  #  3. 当前会话: 设置隔离级别
SELECT * FROM student;                                  #  4. 当前会话: 张一 张二
START TRANSACTION;                                      #  5. 开启事务
INSERT INTO student VALUES(3, '张三');                  #  6. 其他会话: 添加数据
SELECT * FROM student;                                  #  7. 其他会话: 张一 张二 张三
SELECT * FROM student WHERE id = 3;                     #  8. 当前会话: 张三 (对整张表建立快照)
UPDATE student SET name = '张六' WHERE id = 1;          #  9. 其他会话: 修改数据
SELECT * FROM student;                                  # 10. 其他会话: 张六 张二 张三
SELECT * FROM student;                                  # 11. 当前会话: 张一 张二 张三 (使用快照数据)
                                                        #  证明之前是对整张表建立会话, 而不是某一行
DELETE   FROM student WHERE id = 2;                     # 12. 其他会话: 删除数据
SELECT * FROM student;                                  # 13. 其他会话: 张六 张三
SELECT * FROM student;                                  # 14. 当前会话: 张一 张二 张三 (使用快照数据)
COMMIT;

# 3.4 SERIALIZABLE: 操作将变成串行, 效率低 --- 相当于对每一条读记录都加 共享锁
TRUNCATE student;                                       #  1. 清空表
INSERT INTO student VALUES(1, '张一');                  #  2. 初始化数据
INSERT INTO student VALUES(2, '张二');                  #
SET SESSION TRANSACTION_ISOLATION = 'SERIALIZABLE';     #  3. 设置隔离级别
SELECT * FROM student;                                  #  4. 查看数据
START TRANSACTION;                                      #  5. 开启事务
SELECT * FROM student WHERE id = 2;                     #  6. 当前事务: 相当于加了 共享锁
UPDATE student SET name = '123' WHERE id =2 ;           #  7. 其他会讲: 等待中
COMMIT;                                                 #  8. 当前会话: 提交, 释放锁
                                                        #  9. 其他事务更新成功
SELECT * FROM student WHERE id = 2;                     # 10. 此时, 为更新后的结果



TRUNCATE student;                                       #  1. 清空表
INSERT INTO student VALUES(1, '张一');                  #  2. 初始化数据
INSERT INTO student VALUES(2, '张二');                  #
SET SESSION TRANSACTION_ISOLATION = 'SERIALIZABLE';  #  3. 其他会话: 设置隔离级别
SET SESSION TRANSACTION_ISOLATION = 'SERIALIZABLE';  #  4. 当前会话: 设置隔离级别
SELECT * FROM student;                                  #  5. 查看数据
START TRANSACTION;                                      #  6. 开启事务
INSERT INTO student VALUES(3, '张三');                  #  7. 不提交
SELECT * FROM student WHERE id = 3;                     #  8. 当前事务: 张三
SELECT * FROM student WHERE id = 3;                     #  9. 其他会话: 空表, 不能读取到未提交的数据
ROLLBACK;                                               # 10. 回滚
SELECT * FROM student WHERE id = 3;                     # 11. 当前事务: 空表
SELECT * FROM student WHERE id = 3;                     # 12. 其他会话: 空表, 不存在 脏读
SELECT * FROM student WHERE id = 1;                     # 13. 当前会话: 张一
SELECT * FROM student WHERE id = 1;                     # 14. 其他会话: 张一
UPDATE student SET name = '张六' WHERE id = 1;          # 15. 其他会话: 锁定
UPDATE student SET name = '张六' WHERE id = 1;          # 15. 当前会话: 成功 -- 此时, 变成排他锁


SELECT * FROM performance_schema.data_locks

SELECT * FROM student WHERE id = 1;                     # 16. 其他会话: 张六             
SELECT * FROM student WHERE id = 1;                     # 17. 当前会话: 张一 (解决不可重复读)
SELECT * FROM student WHERE id >= 1;                    # 18. 当前会话: 张一 张二
SELECT * FROM student WHERE id >= 1;                    # 19. 其他会话: 张六 张二
INSERT INTO student VALUES(3, '张三');                  # 20. 其他会话: 添加数据
SELECT * FROM student WHERE id >= 1;                    # 21. 其他会话: 张六 张二 张三
SELECT * FROM student WHERE id >= 1;                    # 22. 当前会话: 张一 张二 (解决幻读)
COMMIT;
```
