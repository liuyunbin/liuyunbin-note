
## NAT 的主要目的
NAT(Network Address Translation) 主要目的是解决 IPv4 地址短缺的问题

## NAT 的类型
NAT 主要分为 Basic NAT 和 NAPT，Basic NAT 只是将 IP 地址进行转换，端口号不变，NAPT 则将 IP 和 端口号都转换

## NAPT 的类型
### 1. 完全圆锥形 NAT(Full cone NAT)
1. 一旦 内网 A:X 映射为 公网 B:Y，所有发自 A:X 的数据都经过 B:Y 发送
2. 任何外网都可通过 B:Y 向 A:X 发送数据

### 2. 受限圆锥形 NAT(Address-Restricted cone NAT)
1. 一旦 内网 A:X 映射为 公网 B:Y，所有发自 A:X 的数据都经过 B:Y 发送
2. 如果 A:X 曾经经过 B:Y 向 C:Z 发送过数据，则 C:P 可以通过 B:Y 向 A:X 发送数据，即 只要 IP 相同即可

### 3. 端口受限圆锥形 NAT(port-Restricted cone NAT)
1. 一旦 内网 A:X 映射为 公网 B:Y，所有发自 A:X 的数据都经过 B:Y 发送
2. 如果 A:X 曾经经过 B:Y 向 C:Z 发送过数据，则 C:Z 可以通过 B:Y 向 A:X 发送数据，即 IP 和 端口号必须都相同

### 4. 对称 NAT (Symmetric NAT)
1. 内网 A:X 到 C:Y 和 D:P 的数据拥有不同的映射
2. 如果 A:X 曾经经过 B:Y 向 C:Z 发送过数据，则 C:P 可以通过 B:Y 向 A:X 发送数据，即 只要 IP 相同即可

## 检测 NAT 的类型
需要两个公网的服务器 B:Y C:Z

### 1. 检测是否为公网 IP
1. 客户端使用 A:X 多次给 B:Y 发送数据
2. 服务器 B:Y 多次返回客户端的 D:P
3. 如果 D == A && P == X 则为公网 IP，否则，下一步

### 2. 检测是否为对称 NAT
1. 客户端使用 A:X 多次给 B:Y 发送数据
2. 服务器 B:Y 多次返回客户端的 D:P
3. 客户端使用 A:X 多次给 C:Z 发送数据
2. 服务器 C:Z 多次返回客户端的 E:Q
3. 如果 P != Q 则为对称 NAT，否则，下一步

### 3. 检测是否为完全圆锥形 NAT
1. 客户端使用 A:X 通过 D:P 多次给 B:Y 发送数据
2. 服务器 C:Z 通过 D:P 多次给 A:X 发送消息
3. 如果客户端可以收到消息，则为 完全圆锥形 NAT，否则，下一步

### 4. 检测是否为受限圆锥形 NAT
1. 客户端使用 A:X 通过 D:P 多次给 B:Y 发送数据
2. 服务器 B:Z 通过 D:P 多次给 A:X 发送消息
3. 如果客户端可以收到消息，则为 受限圆锥形 NAT，否则，下一步

### 5. 检测是否为端口受限圆锥形 NAT
1. 客户端使用 A:X 通过 D:P 多次给 B:Y 发送数据
2. 服务器 B:Y 通过 D:P 多次给 A:X 发送消息
3. 如果客户端可以收到消息，则为 端口受限圆锥形 NAT

## UDP hole punching
主要用于位于不同 NAT 中的客户直接通信

### 方法
假设有两个客户 A:X B:Y 位于不同的 NAT 中，还有一个处于公网的服务器 C:Z

#### 情况 1： A:X 或 B:Y 所属的 NAT 为完全锥形 NAT
假定 A:X 所属的 NAT 为完全锥形 NAT，B:X 所属的 NAT 任意

1. 客户 A:X 通过 D:P 多次发送数据给 C:Z
2. 在此之后，任意客户都可以通过 D:P 给客户 A:X 发送消息

#### 情况 2： A:X 或 B:Y 所属的 NAT 为受限锥形 NAT
假定 A:X 所属的 NAT 为受限锥形 NAT，B:X 所属的 NAT 任意

1. 客户 A:X 通过 D:P 多次发送数据给 C:Z
2. 客户 B:Y 通过 E:Q 多次发送数据给 C:Z
3. 服务器 C:Z 将 A:X 的映射的 D:P 多次发送给 B:Y
4. 服务器 C:Z 将 B:Y 的映射的 E:Q 多次发送给 A:X
5. 客户 A:X 多次发送数据给 E:Q
6. 在此之后，客户 B:Y 可以通过 D:P 给客户 A:X 发送消息
7. 在此之后，客户 A:X 可以 B:Y 所映射的 IP:PORT 给客户 B:Y 发送消息

#### 情况 3： A:X 和 B:Y 所属的 NAT 均为端口受限锥形 NAT
1. 客户 A:X 通过 D:P 多次发送数据给 C:Z
2. 客户 B:Y 通过 E:Q 多次发送数据给 C:Z
3. 服务器 C:Z 将 A:X 的映射的 D:P 多次发送给 B:Y
4. 服务器 C:Z 将 B:Y 的映射的 E:Q 多次发送给 A:X
5. 客户 A:X 多次发送数据给 E:Q
6. 在此之后，客户 B:Y   可以通过 E:Q --> D:P 给客户 A:X 发送消息
7. 在此之后，客户 A:X 也可以通过 D:P --> E:Q 给客户 B:Y 发送消息

#### 情况 4： A:X 和 B:Y 所属的 NAT 均为对称 NAT
此情况无法穿透

#### 情况 5： A:X 和 B:Y 所属的 NAT 一个为 对称 NAT，一个为端口受限的 NAT
此情况无法穿透

