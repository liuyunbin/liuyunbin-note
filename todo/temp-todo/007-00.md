
# 操作系统-会话
## 存在意义
* 为了便于终端的处理

## 新建会话
* 新的会话ID是当前进程的ID, 新的进程组ID也是当前进程的ID
* 新会话和新进程组里将只包含当前进程
* 新的会话将脱离终端的控制
* 当前进程是进程组的首进程时, 不能新建会话, 避免出现同一进程组的进程属于不同的会话的情况 -- 007-01.cc
    1. 当前进程的进程ID和进程组ID相同, 即是进程组的首进程
    2. 新建会话, 失败
* 当前进程不能是进程组的首进程时, 可以新建会话 -- 007-02.cc
    1. 当前进程产生子进程
    2. 子进程的进程ID和进程组ID不同, 即不是进程组的首进程
    2. 子进程新建会话, 成功

## 销毁会话(会话不和终端绑定)
* 会话首进程退出时, 不会对会话内的其他进程有影响 -- 007-03.cc
    1. 父进程产生子进程
    2. 子进程新建会话
    3. 子进程产生孙进程
    4. 此时, 子孙进程属于同一会话, 子进程是会话首进程
    5. 杀死子进程(会话首进程)
    6. 孙进程可以正常运行, 只是变成孤儿进程

## 和进程 进程组 终端的关系
* 一个会话包含一个或多个进程
* 一个会话包括一个或多个进程组
* 一个会话最多和一个终端绑定

## 终端
* 用户登录时, 系统将一个会话与终端绑定, 此会话进程即为控制进程
* 终端退出时, 将发送 SIGHUP 给控制进程, 控制进程将向此会话中的所有进程组发送信号 SIGHUP
    * 对于暂停的作业将先发送 SIGCONT 和 SIGTERM 信号
* 此会话有且只有一个前台进程组, 有零个或多个后台进程组
* 终端的输入将发送到前台进程组, 前台和后台进程组的输出都将发送到终端
* 新建会话可以脱离终端
* 脱离终端的进程的父进程不一定是 1, 也可能是其他脱离终端的进程
* 脱离终端可以忽略 SIGHUP 或 新建会话

## 守护进程
1. 产生子进程, 然后父进程退出, 保证子进程不是进程组的首进程
2. 新建会话, 保证子进程脱离终端的控制
3. 关闭所有的文件描述符, 避免受到父进程文件描述符的影响
4. 设置权限掩码, 避免受到父进程掩码的影响
5. 切换到根目录, 因为当前目录可能会被卸载或删除

参见开源项目: https://github.com/lighttpd/spawn-fcgi

